---
title: "Job Flows Into Fairfax County"
description: "Project description here"
tags: ["R", "geospatial"]
weight: 5
draft: false
output: html_document
---

NOTES FOR THIS FILE:
* COLOR SCHEME
* ADD CONTENT AS NOTED

```{r warning = F, message = F, results = 'hide', echo = F}
library(dplyr)
library(ggplot2)
library(readr)
library(tidyverse)
library(forcats)
library(sf)
library(tmap)
library(leaflet)
library(stplanr)
library(tigris)
```

```{r warning = F, message = F, results = 'hide', echo = F}
# Read in data
jobs_all <- read_csv("~/git/dspg20fairfax/data/od/jobsall.csv", col_types = cols(h_geocode_tract = col_character(), w_geocode_tract = col_character()))

va_xw <- read_csv("~/git/dspg20fairfax/data/original/va_xwalk.csv")
```

```{r warning = F, message = F, echo = F} 
# Parsing GEOID
jobs_all$h_state <- substr(jobs_all$h_geocode_tract, 1, 2)
jobs_all$h_county <- substr(jobs_all$h_geocode_tract, 3, 5)
jobs_all$h_tract <- substr(jobs_all$h_geocode_tract, 6, 11)
jobs_all$h_stcty <- substr(jobs_all$h_geocode_tract, 1, 5)

# Now parsing workplace GEOIDs
jobs_all$w_state <- substr(jobs_all$w_geocode_tract, 1, 2)
jobs_all$w_county <- substr(jobs_all$w_geocode_tract, 3, 5)
jobs_all$w_tract <- substr(jobs_all$w_geocode_tract, 6, 11)
jobs_all$w_stcty <- substr(jobs_all$w_geocode_tract, 1, 5)
```

```{r warning = F, message = F, results = 'hide', echo = F}
# Reading in for mapping later
nc_xw <- read_csv("~/git/dspg20fairfax/data/original/xwalk/nc_xwalk.csv", col_types = cols(cty = col_character()))
dc_xw <- read_csv("~/git/dspg20fairfax/data/original/xwalk/dc_xwalk.csv", col_types = cols(cty = col_character()))
pa_xw <- read_csv("~/git/dspg20fairfax/data/original/xwalk/pa_xwalk.csv", col_types = cols(cty = col_character()))
wv_xw <- read_csv("~/git/dspg20fairfax/data/original/xwalk/wv_xwalk.csv", col_types = cols(cty = col_character()))
md_xw <- read_csv("~/git/dspg20fairfax/data/original/xwalk/md_xwalk.csv", col_types = cols(cty = col_character()))
oh_xw <- read_csv("~/git/dspg20fairfax/data/original/xwalk/oh_xwalk.csv", col_types = cols(cty = col_character()))
ny_xw <- read_csv("~/git/dspg20fairfax/data/original/xwalk/ny_xwalk.csv", col_types = cols(cty = col_character()))
fl_xw <- read_csv("~/git/dspg20fairfax/data/original/xwalk/fl_xwalk.csv", col_types = cols(cty = col_character()))
nj_xw <- read_csv("~/git/dspg20fairfax/data/original/xwalk/nj_xwalk.csv", col_types = cols(cty = col_character()))
sc_xw <- read_csv("~/git/dspg20fairfax/data/original/xwalk/sc_xwalk.csv", col_types = cols(cty = col_character()))
```

```{r warning = F, message = F, results = 'hide', echo = F}
# Loading top 10 states to map flows
va_points <- tracts("VA", class = "sf")
md_points <- tracts("MD", class = "sf")
dc_points <- tracts("DC", class = "sf")
wv_points <- tracts("WV", class = "sf")
pa_points <- tracts("PA", class = "sf")
nc_points <- tracts("NC", class = "sf")
nj_points <- tracts("NJ", class = "sf")
ny_points <- tracts("NY", class = "sf")
oh_points <- tracts("OH", class = "sf")
sc_points <- tracts("SC", class = "sf")
fl_points <- tracts("FL", class = "sf")
```

# Job Flows Into Fairfax County
Knowing that there would be the possibility of network analysis for jobs flows in and out of Fairfax County, this analysis and mapping helps inform where to focus our efforts by mapping the flows for 10 counties within Virginia that have the most workers in Fairfax, 10 states that have the most workers in Fairfax, and 10 counties outside Virginia that have the most workers in Fairfax.  This helps narrow our frame of possible networks to explore.

## Data and Methods
The main driving data source we used here was LODES Origin Destination data, filtering it down to just those who work in Fairfax County and live elsewhere.  We also used state crosswalk data to convert GEOIDs to county and state names.  Finally, we used tract sf objects in order to get the geometry of the origins of these workers.  We used many packages when working with the data, mainly dyplr, tidyverse, readr, sf, tigris, and stplnr.  When visualizing and mapping the data we used ggplot, leaflet, and tmap.  The map visualization showcase the top 10 flows into Fairfax County from the centroids of states or counties.  

## Findings
From within Virginia, Loudoun County and Prince William County are the counties that have the greatest number of workers living there that work in Fairfax County.  From other states, Maryland has the greatest number of workers living there that are working in Fairfax County.  From counties in other states, Montgomery County, Prince George's County, and the District of Columbia are the top 3 areas that have the greatest number of workers living there that work in Fairfax County.

# What Percent of Jobs Flow to Fairfax County from Outside of the County?
Filtering all jobs in Virginia by those with residence geography outside of Fairfax but workplace geography inside of Fairfax, we were able to get all jobs that are flowing into the county.  59% of all jobs in Fairfax County come from people who do not live there, giving us an indication that exploring networks is a viable path to take.
```{r}
#this means all jobs where residence is outside of Fairfax but workplace is in Fairfax
flows_in <- jobs_all %>% filter(h_stcty != "51059" & w_stcty == "51059")
bool_cond <- jobs_all$h_stcty != "51059" & jobs_all$w_stcty == "51059"

percents <- data.frame("type" = c("From outside Fairfax County", "From within Fairfax County"), "shares" = c((mean(bool_cond) * 100), ((1 - mean(bool_cond)) * 100)))
percents
pie <- ggplot(percents, aes("", y = shares, fill = type)) +
  geom_bar(stat="identity", width=1) + 
  geom_text(aes(label = paste0(round(shares), "%")), position = position_stack(vjust = 0.5))
 
pie <- pie  +
  coord_polar("y", start=0) +
  scale_fill_manual(values=c("#D1E0BF", "#0E879C")) +
  labs(x = NULL, y = NULL, fill = NULL, title = "Geographic Origin of Jobs Flows Into Fairfax County") +
  theme_classic() +
  theme(axis.line = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          plot.title = element_text(hjust = 0.5))
pie
```

```{r warning = F, message = F, results = 'hide', echo = F}
#NC done
essential <- nc_xw %>%
  select(cty, ctyname)
nc_names <- inner_join(x = flows_in, y = unique(essential), by = c("h_stcty" = "cty"))

#dc done
essential <- dc_xw %>%
  select(cty, ctyname)
dc_names <- inner_join(x = flows_in, y = unique(essential), by = c("h_stcty" = "cty"))

#pa done
essential <- pa_xw %>%
  select(cty, ctyname)
pa_names <- inner_join(x = flows_in, y = unique(essential), by = c("h_stcty" = "cty"))

#wv done
essential <- wv_xw %>%
  select(cty, ctyname)
wv_names <- inner_join(x = flows_in, y = unique(essential), by = c("h_stcty" = "cty"))

#md done
essential <- md_xw %>%
  select(cty, ctyname)
md_names <- inner_join(x = flows_in, y = unique(essential), by = c("h_stcty" = "cty"))

#oh done
essential <- oh_xw %>%
  select(cty, ctyname)
oh_names <- inner_join(x = flows_in, y = unique(essential), by = c("h_stcty" = "cty"))

#ny done
essential <- ny_xw %>%
  select(cty, ctyname)
ny_names <- inner_join(x = flows_in, y = unique(essential), by = c("h_stcty" = "cty"))

#fl done
essential <- fl_xw %>%
  select(cty, ctyname)
fl_names <- inner_join(x = flows_in, y = unique(essential), by = c("h_stcty" = "cty"))

#nj done
essential <- nj_xw %>%
  select(cty, ctyname)
nj_names <- inner_join(x = flows_in, y = unique(essential), by = c("h_stcty" = "cty"))

#sc done
essential <- sc_xw %>%
  select(cty, ctyname)
sc_names <- inner_join(x = flows_in, y = unique(essential), by = c("h_stcty" = "cty"))
```

# Of the Job Flows into Fairfax County from Outside the County, what Percent are from Other Virginia Counties?
Of the jobs flowing into Fairfax County from outside the county, about 56% are from other counties in the state.  Particularly coming from Loudoun County and Prince William County.
```{r}
perc_flows_other_counties_VA <- mean(flows_in$h_state == "51") *100
perc_flows_other_counties_VA
agg_cnty_VA <- flows_in[flows_in$h_state == "51", ] %>%
  group_by(h_county) %>%
  summarise(S000 = sum(S000)) %>%
  ungroup()
#Use VA crosswalk to get county names
va_xw$h_county <- substring(va_xw$cty, 3, 6)
essential <- va_xw %>%
  select(h_county, ctyname)
agg_cnty_VA_with_names <- inner_join(x = agg_cnty_VA, y = unique(essential), by = "h_county")
agg_cnty_VA_trimmed <- agg_cnty_VA_with_names[order(-agg_cnty_VA_with_names$S000), ][1:10, ]
agg_cnty_VA_trimmed %>%
  mutate(ctyname = fct_reorder(ctyname, S000)) %>%
  ggplot(aes(S000, ctyname)) +
  geom_bar(stat="identity", fill = "#E57200") +
  ggtitle("Number of Jobs Flowing into Fairfax\n from Other Virginia Counties") +
  xlab("Number of Jobs") + 
  ylab("Origin County Name") +
  scale_x_continuous(labels = scales::comma)
```

# Map of Major Flows to Fairfax County from Other Virginia Counties
Visualizing these flows on a map we can see geographically the space these networks span and the importance that Fairfax County employment has not only on their own community but on many other communities further away.
```{r}
#by VA county
flows_in_VA_cnty <- flows_in[flows_in$h_state == "51", ] %>%
  group_by(h_stcty, w_stcty) %>%
  summarise(S000 = sum(S000)) %>%
  ungroup() %>%
  arrange(-S000)
#join with names of h_county
essential <- va_xw %>%
  select(cty, ctyname)
essential$cty <- as.character(essential$cty)
flows_in_VA_cnty <- inner_join(x = flows_in_VA_cnty, y = unique(essential), by = c("h_stcty" = "cty"))

va_cnty <- counties("VA")
va_cnty_flow_lines <- st_as_sf(od2line(flows_in_VA_cnty[1:10, ], va_cnty, 
                                       origin_code = "h_stcty", dest_code = "w_stcty", 
                                 zone_code = "GEOID"))

tmap_mode("view")
pal <- viridis::viridis(n = 3, option = "C")
top10VA_cnty_flowsmap <- tm_shape(va_cnty_flow_lines %>% select(ctyname, w_stcty, S000, geometry)) +
  tm_lines(lwd = 3.5, col = "S000", title.col = "Number of Jobs", style = "quantile",
           palette = c("#60999A", "#E57200"),
           popup.vars = c("Number of Jobs" = "S000")) +
  tm_basemap("OpenStreetMap.HOT") +
  tm_view(set.zoom.limits = c(8, 18), basemaps.alpha = 0.5)
top10VA_cnty_flowsmap
```

# Of the Job Flows into Fairfax County from Outside the County, What Percent are from Other States?
Of the jobs flowing into Fairfax County from outside the county, about 43% are from other states.  Particularly coming from Maryland and Washington DC.  Fairfax County is close to state boarders so this is expected and worth exploring.

```{r}
percent_flows_other_states <- mean(flows_in$h_state != "51") * 100
percent_flows_other_states
agg_states_no_names <- flows_in[flows_in$h_state != "51", ] %>%
  group_by(h_state) %>%
  summarise(S000 = sum(S000)) %>%
  ungroup()
agg_states_trimmed <- agg_states_no_names[order(-agg_states_no_names$S000), ][1:10, ]
agg_states_trimmed$State <- c("Maryland", "District of Columbia", "West Virginia", "Pennsylvania", "North Carolina", "New Jersey", "New York", "Ohio", "South Carolina", "Florida")
agg_states_trimmed %>%
  mutate(ctyname = fct_reorder(State, S000)) %>%
  ggplot(aes(S000, ctyname)) +
  geom_bar(stat="identity", fill= "#E57200") +
  ggtitle("Number of Jobs flowing into Fairfax from other states") +
  xlab("Number of Jobs") + 
  ylab("State") +
  scale_x_continuous(labels = scales::comma)
```

# Map of Major Flows to Fairfax County from Other States
When visualizing the flows on a map we can see some interesting things.  Particularly states like Florida and South Carolina.  These states send in relatively few jobs and are located a large distance from Fairfax County.  For these flows, the outliers we are taking with a grain of salt, perhaps their main office is in Fairfax but they live and work in Florida/South Carolina.  The data does not tell us this, but we are likely going to focus our network efforts on adjacent states because they make more sense and also send in the majority of jobs.
```{r}
flows_in_state <- flows_in[flows_in$h_state != "51", ] %>%
  group_by(h_state, w_state) %>%
  summarise(S000 = sum(S000)) %>%
  ungroup() %>%
  arrange(-S000)
#get states names
flows_in_state <- flows_in_state[1:10, ]
flows_in_state$State <- c("Maryland", "District of Columbia", "West Virginia", "Pennsylvania", "North Carolina", "New Jersey", "New York", "Ohio", "South Carolina", "Florida")

states_flow_lines <-st_as_sf(od2line(flows_in_state, states()[3:10]))
tmap_mode("view")
pal <- viridis::viridis(n = 3, option = "C")
top10states_flowsmap <- tm_shape(states_flow_lines %>% select(State, w_state, S000, geometry)) +
  tm_lines(lwd = 3.5, 
           col = "S000", 
           title.col = "Number of Jobs", 
           style = "quantile",
           palette = c("#60999A", "#E57200"),
           popup.vars = c("Number of Jobs" = "S000")) +
  tm_basemap("OpenStreetMap.HOT") +
  tm_view(set.zoom.limits = c(5, 18), basemaps.alpha = 0.5)
top10states_flowsmap
```

# Of the Job Flows into Fairfax County from Outside the County, what are their origins by County in other states?
Of the jobs flowing into Fairfax County from outside the county, many come from counties in Maryland, Washington DC, and West Virginia. Particularly from Montgomery County, MD, Price George's County, MD, and Washington DC.

```{r}
top_ten_with_names <- rbind(nc_names, dc_names, pa_names, wv_names, md_names, oh_names, ny_names, fl_names, nj_names, sc_names)
agg_cnty_other_with_names <- top_ten_with_names %>%
  group_by(ctyname) %>%
  summarise(S000 = sum(S000)) %>%
  ungroup()
agg_cnty_other_trimmed <- agg_cnty_other_with_names[order(-agg_cnty_other_with_names$S000), ][1:10, ]
agg_cnty_other_trimmed %>%
  mutate(ctyname = fct_reorder(ctyname, S000)) %>%
  ggplot(aes(S000, ctyname)) +
  geom_bar(stat="identity", fill= "#E57200") +
  ggtitle("Number of Jobs Flowing into Fairfax from Other\n Counties in Other States") +
  xlab("Number of Jobs") + 
  ylab("County Name") +
  scale_x_continuous(labels = scales::comma)
```

# Map of Major Flows to Fairfax County by County Origin in Other States
This map is similar to the map of flows from other states to Fairfax County, but it provides further granularity.  The top 10 counties from other states, though, come from far fewer states and are much closer, allowing us to methodically narrow our frame for network analysis.
```{r}
top_ten_with_names$h_stcty <- substr(top_ten_with_names$h_geocode_tract, 1, 5)
top_ten_with_names$w_stcty <- substr(top_ten_with_names$w_geocode_tract, 1, 5)
flows_from_other <- top_ten_with_names %>%
  group_by(h_stcty, w_stcty, ctyname) %>%
  summarise(S000 = sum(S000)) %>%
  ungroup() %>%
  arrange(-S000)
all_points <- rbind(va_points, md_points, dc_points, wv_points, pa_points, nc_points, ny_points, ny_points, oh_points, sc_points, fl_points)
all_points$h_stcty <- paste(all_points$STATEFP, all_points$COUNTYFP, sep = "")

other_cnty_flow_lines <- od2line(flows_from_other[1:10, ], all_points,
                                 origin_code = "h_stcty", dest_code = "w_stcty", 
                                 zone_code = "h_stcty")
other_cnty_flow_lines <- st_as_sf(other_cnty_flow_lines)
other_cnty_flow_lines
tmap_mode("view")
pal <- viridis::viridis(n = 3, option = "C")
top10other_cnty_flowsmap <- tm_shape(other_cnty_flow_lines %>% select(ctyname, w_stcty, S000, geometry)) +
  tm_lines(lwd = 3.5, col = "S000", title.col = "Number of Jobs", style = "quantile",
           palette = c("#60999A", "#E57200"),
           popup.vars = c("Number of Jobs" = "S000")) +
  tm_basemap("OpenStreetMap.HOT") +
  tm_view(set.zoom.limits = c(8, 18), basemaps.alpha = 0.5)
top10other_cnty_flowsmap
```

# References
Citations here.
