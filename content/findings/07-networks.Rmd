---
title: "Fairfax County Networks"
description: "Project description here"
tags: ["R", "geospatial"]
weight: 5
draft: false
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(tidycensus)
library(leaflet)
library(sf)
library(shiny)
library(fabricatr)
library(RColorBrewer)

source("/sfs/qumulo/qhome/sm9dv/dspg20fairfax/src/09_network_descriptives/network_functions.R")
network_stats(vars = "S000", years = 2015, types = types)
```

# Fairfax County Networks

We employ network analysis to understand the flow of Fairfax County workers from their residence to the workplace at the Census tract-level. 

## Data and Methods

The LODES data is produced by the US Census Bureau in order to better understand where workers reside and work. There are three main datasets of the LODES data; we use the Origin-Destination files for our networks, and restrict the geography to intra-Fairfax County tracts only. The LODES OD data is produced for three aggregations: total jobs, federal jobs, and private jobs. While the LODES data provides flows for all workers that live or work in Fairfax County, we decided to reduce the networkâ€™s data for the DSPG project to only include those that live in Fairfax County. Our data profiling of residents deriving from outside of Fairfax County revealed that some workers live in states well outside of driving distance. This created a challenge that makes it hard to determine whether workers work for businesses with headquarters in Fairfax but work elsewhere or whether they do work in Fairfax only part of the time. For these reasons, we decided to only focus on flows deriving from within Fairfax County.


### Interpretation of Centrality Measures

In network theory, measures of centrality show the importance of nodes by certain criteria. In this project, nodes are tracts. The table below presents our main centrality measures. The interpretation contextualizes centrality measures within the Fairfax County job flows theme. While we eventually plan to conduct some machine learning on a broader collection of network centrality measures, our short-term goal was just to see which Census tracts are most important when analyzing them as a network. 

Measure | Interpretation
---------|--------------------------------
Weighted Out-Degree Centrality | These plots highlight tracts from which individuals depart to get to their jobs in other tracts.
Weighted In-Degree Centrality | These plots highlight tracts that are work destinations.
Betweenness Centrality | The plots highlight tracts that serve as bridges for workers from disparate tracts to flow through.
Eigenvector Centrality | The plots highlight tracts that are more important based on they are connected to other well-connected tracts.


## Findings

The maps below show the centrality measures for all jobs in Fairfax County. The top, left-hand plot shows weighted out-degree centrality by quantile group. We see that many tracts on the western side of Fairfax County are darker, meaning that more individuals are leaving those tracts to commute to work. Looking at the top, right-hand map, we see in-degree centrality, which highlights workplace destinations. Many tracts on the eastern side of Fairfax County are highlighted, meaning the more individuals work in those tracts. Taken together, the maps have implications on travel flow during peak commute hours. 

The bottom left map displays betweenness centrality. Betweenness centrality shows tracts that serve as bridges for workers commuting to and from work. The betweenness centrality of certain tracts could be an indicator of emerging areas for new businesses. In comparison to SDAD's prior Fairfax County gentrification research, the betweenness measures closely align with the measures of gentrification. This further indicates that network analysis helps provide some capacity of predicting emerging economic geographies and, in turn, further indicates that infrastructure will need to be built to reflect these emerging trends.

The bottom, right map shows eigenvector centrality, which highlights tracts based on connections to other well-connected tracts. In the context of Fairfax County, these tracts would see relatively higher travel, which could see more stress to infrastructure. 

_Interpreting Quantiles: The maps visualize measure of centrality values at tract level. Counties with darker map colors have higher measures of centrality. Conversely, counties with lighter colors have lower measure of centrality. To facilitate comparisons and display quintile cut-off points, map colors represent quintile-grouped values._

##### All JOBS

```{r, echo = F}
leaflet_creator("all")
fluidRow(column(6, l_out_2015_S000_all), 
         column(6, l_in_2015_S000_all))
fluidRow(column(6, l_btw_2015_S000_all), 
         column(6, l_eigen_2015_S000_all))
```

We repeat the analysis, but restrict the data to federal jobs only. For the top left map, which shows weighted out-degree centrality, we see that as before, many workers live in the western area of Fairfax County. The in-degree centrality map looks noticeably different. A major takeaway from this map is that there are key tracts were many federal jobs are located. For example, the darkest tract in the western area of Fairfax County, near Reston, is the home to the US Geological Survey office, and Bureau of Indian Affairs, Division of Acquisitions. The northern-most, darkest tract in the western area of Fairfax County, located in Bailey's Crossroads, is home to one of the US Fish & Wildlife Services National Headquarters.

Betwenness centrality, as shown in the bottom left map, shows tracts that serve as bridges for federal workers commuting to and from work. Many of the highlighted tracts are located at key intersections, including the Leesburg Pike (Route 7)/Dulles Access Road (Route 267) intersection and the 95/395/495 intersection. 

The federal jobs eigenvector map (bottom right) also shows the importance of major intersections. Darker tracts would see relatively higher travel, which could see more stress to infrastructure. We see darker tracts near Leesburg Pike (Route 7)/Dulles Access Road (Route 267) intersection and the 95/395/495 intersection. 

### FEDERAL JOBS

```{r, echo = F}
type = "federal"
nodelist <- get(paste("nodelist_2015_S000_", type, sep = ""))
  
  
nodelist$color_in <- ifelse(nodelist$wtd_deg_cent_in == 0, "[0]", 
                        ifelse(nodelist$wtd_deg_cent_in < 1000 & 100 <= nodelist$wtd_deg_cent_in, "[100-1000)",
                              ifelse(nodelist$wtd_deg_cent_in < 100 &  10 <= nodelist$wtd_deg_cent_in, "[10-100)", 
                                     "[1-10)")))
nodelist$color_btw <- ifelse(nodelist$btw_cent == 0, "[0]", 
                        ifelse(nodelist$btw_cent < 1000 & 100 <= nodelist$btw_cent, "[100-1000)",
                              ifelse(nodelist$btw_cent < 100 &  10 <= nodelist$btw_cent, "[10-100)", 
                                     "[1-10)")))
nodelist$color_eigen <- ifelse(nodelist$eigen_cent == 0, "[0]", 
                        ifelse(nodelist$eigen_cent < 1 & .1 <= nodelist$eigen_cent, "[.1-1)",
                              ifelse(nodelist$eigen_cent < 0.01 &  0 < nodelist$eigen_cent, "(0-.01)", 
                                     "[.01-.1)")))
  
nodelist$color_eigen <- ordered(nodelist$color_eigen, levels = c("[0]", "(0-.01)","[.01-.1)", "[.1-1)"))
fairfax_data <- merge(data_fairfax[, c("GEOID", "geometry")], nodelist[, c("tract", "wtd_deg_cent_out", "wtd_deg_cent_in", "btw_cent", "eigen_cent", "color_in", "color_btw","color_eigen")], by.x= "GEOID", by.y = "tract", all = TRUE)
  
fairfax_data <- st_transform(fairfax_data, 4326)

pal_out <- colorQuantile(palette = c("#DEEBF7", "#232d4b"),5,  domain = fairfax_data$wtd_deg_cent_out)
pal_in <- colorFactor(palette = c("#E5F5F9", "#0e879c"), fairfax_data$color_in)
pal_btw <- colorFactor(palette = c("#FAF6DB", "#E6CE3A"), fairfax_data$color_btw)
pal_eigen <- colorFactor(palette = c("#FEE6CE", "#E6A01D"), fairfax_data$color_eigen)

l_out_2015_S000_federal <- leaflet(data = fairfax_data,options = leafletOptions(minZoom = 10))%>%
  addTiles("https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}.png") %>%
  addPolygons(fillColor = ~pal_out(wtd_deg_cent_out), fillOpacity = .8, stroke = FALSE) %>%
  addLegend("bottomleft", 
            pal = pal_out, 
            values =  ~wtd_deg_cent_out,
            title = "Weighted Degree Centrality: Out<br> By Quantile Group", 
            opacity = 1, 
            labFormat = function(type = "quantile", cuts = 10, p = wtd_deg_cent_out) {
              n = length(cuts)
              paste0("[", round(cuts[-n], 3), " &ndash; ", round(cuts[-1], 3), ")")
            })
l_in_2015_S000_federal <- leaflet(data = fairfax_data,options = leafletOptions(minZoom = 10))%>%
  addTiles("https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}.png") %>%
  addPolygons(fillColor = ~pal_in(color_in), fillOpacity = .8, stroke = FALSE) %>%
  addLegend("bottomleft", 
            pal = pal_in, 
            values = ~color_in,
            title = "Weighted Degree Centrality: In<br>", 
            opacity = 1
          )
l_btw_2015_S000_federal <- leaflet(data = fairfax_data,options = leafletOptions(minZoom = 10))%>%
  addTiles("https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}.png") %>%
  addPolygons(fillColor = ~pal_btw(color_btw), fillOpacity = .8, stroke = FALSE) %>%
  addLegend("bottomleft", 
            pal = pal_btw, 
            values = ~color_btw,
            title = "Betweenness Centrality<br>", 
            opacity = 1)
l_eigen_2015_S000_federal <- leaflet(data = fairfax_data, options = leafletOptions(minZoom = 10))%>%
  addTiles("https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}.png") %>%
  addPolygons(fillColor = ~pal_eigen(color_eigen), fillOpacity = .8, stroke = FALSE) %>%
  addLegend("bottomleft", 
            pal = pal_eigen, 
            values = ~color_eigen,
            title = "Eigen Centrality<br>", 
            opacity = 1)

fluidRow(column(6, l_out_2015_S000_federal), 
         column(6, l_in_2015_S000_federal))
fluidRow(column(6, l_btw_2015_S000_federal), 
         column(6, l_eigen_2015_S000_federal))
```

### PRIVATE JOBS

The private jobs networks reflect the all jobs networks. 

```{r, echo = F}
leaflet_creator("private")
fluidRow(column(6, l_out_2015_S000_private), 
         column(6, l_in_2015_S000_private))
fluidRow(column(6, l_btw_2015_S000_private), 
         column(6, l_eigen_2015_S000_private))
```


# References
Citations here.