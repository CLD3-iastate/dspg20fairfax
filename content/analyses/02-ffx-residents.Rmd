---
title: "Fairfax County Residents' Employment Characteristics"
output: html_document
description: "Project description here"
tags: ["R", "geospatial"]
weight: 2
draft: false
---

NOTES FOR THIS DOCUMENT:
* ADD CONTENT AS MARKED.

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning = F, message = F, echo = F}
library(tidyverse)
library(leaflet)
library(shiny)
library(shinythemes)
library(sf)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(stringr)
```

```{r warning = F, message = F, echo = F}
# Get data
rac <- read_rds("/sfs/qumulo/qhome/tp2sk/Git/dspg20fairfax/data/lodes/fairfax_rac.Rds") # Sean's LODES 2017 residence tract data
```

```{r, warning = F, message = F, echo = F}
# Function to transform pie chart labels
pie_lab_transform <- function(data){
  data <- data %>% 
  arrange(desc(data)) %>%
  mutate(prop = value / sum(value) *100) %>%
  mutate(ypos = cumsum(prop)- 0.5*prop )
}
```

# Fairfax County Residents' Employment Characteristics
Write introduction here.

## Data and Methods
Describe data sources and what we did here.

## Fairfax County Residents in Labor Force
Give a brief summary of findings, then describe each output below.

## Sociodemographic Characteristics
Describe.
```{r, echo = F}
age <- data.frame(age=names(colSums(rac[, 3:5])), value=colSums(rac[, 3:5]), row.names=NULL)
age <- pie_lab_transform(age)

ggplot(age, aes(x="", y=prop, fill=age)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  theme_void() +
  theme(legend.position="none") +
  geom_text(aes(y = ypos, label = paste(age, "\n", paste(round(prop, 2), "%"))), color = "white", size=3) +
  labs(title = "Age Structure of Employed Fairfax County Residents", subtitle = "LODES Residence Characteristics, 2017")
```

Describe.
```{r, echo = F}
race <- data.frame(race=names(colSums(rac[, 29:34])), value=colSums(rac[,29:34]), row.names=NULL)
race <- pie_lab_transform(race)

for(i in  c("Race:", ",Alone", "Alone", "10")){
  race$race <- gsub(i, "", race$race)
}

ggplot(race, aes(x = prop, y = reorder(race, prop), fill = race)) +
  geom_bar(stat= "identity")+
  theme_minimal() +
  labs(title = "Race of Employed Fairfax County Residents", subtitle = "LODES Residence Characteristics, 2017", y = "", x = "%")+
  theme(legend.position="none")
```

```{r, echo = F}
ethnicity <- data.frame(ethnicity=names(colSums(rac[,35:36])), value=colSums(rac[, 35:36]), row.names=NULL)
ethnicity <- pie_lab_transform(ethnicity)

for(i in  c("Ethnicity:", "10")){
  ethnicity$ethnicity <- gsub(i, "", ethnicity$ethnicity)
}

ggplot(ethnicity, aes(x="", y=prop, fill=ethnicity)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  theme_void() +
  theme(legend.position="none") +
  geom_text(aes(y = ypos, label = paste(ethnicity, "\n", paste(round(prop, 2), "%"))), color = "white", size=3) +
  labs(title = "Ethnicity of Employed Fairfax County Residents", subtitle = "LODES Residence Characteristics, 2017")
```

Describe.
```{r, echo = F}
education <- data.frame(education=names(colSums(rac[,37:40])), value=colSums(rac[, 37:40]), row.names=NULL)
education <- pie_lab_transform(education)

for(i in  c("EducationalAttainment:", "10,11")){
  education$education <- gsub(i, "", education$education)
}

ggplot(education, aes(x="", y=prop, fill=education)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  theme_void() +
  theme(legend.position="none") +
  geom_text(aes(y = ypos, label = paste(education, "\n", paste(round(prop, 2), "%"))), color = "white", size=3) +
  labs(title = "Education of Employed Fairfax County Residents", subtitle = "LODES Residence Characteristics, 2017")
```

### Employment Characteristics
```{r, echo = F}
earnings <- data.frame(earnings=names(colSums(rac[, 6:8])), value=colSums(rac[, 6:8]), row.names=NULL)

earnings$earnings <- gsub("earnings", "", earnings$earnings)

earnings <- pie_lab_transform(earnings)

ggplot(earnings, aes(x="", y=prop, fill=earnings)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  theme_void() +
  theme(legend.position="none") +
  geom_text(aes(y = ypos, label = paste(earnings, "\n", paste(round(prop, 2), "%"))), color = "white", size=3) +
  labs(title = "Earnings Structure of Employed Fairfax County Residents", subtitle = "LODES Residence Characteristics, 2017")
```

### Which industry sectors employ Fairfax County residents?
```{r, echo = F}
naic <- data.frame(naic=names(colSums(rac[,9:28])), value=colSums(rac[, 9:28]), row.names=NULL)

naic$naic <- unlist(str_extract_all(naic$naic,  "(?<=\\().+?(?=\\))"))
naic$naic <- gsub("and", "&", naic$naic)
naic <- pie_lab_transform(naic)

ggplot(naic, aes(x = prop, y = reorder(naic,prop), fill = naic)) +
  geom_bar(stat= "identity") +
  theme_minimal() +
  labs(title = "Industry of Employed Fairfax County Residents", subtitle = "LODES Residence Characteristics, 2017", y = "", x = "%")+
  theme(legend.position="none")
```

### Exploring Work Commutes, Worker Classes, and Industries
Describe how the map works, what it shows, and main takeaways.
```{r warning = F, message = F, echo = F}
# Shiny app goes here, I just need to integrate it.
# This app shows maps (after selection) for all commute types, all class of worker types, and all industry sectors. See static plots that we already have for what shows up.
```

# References
Cite references here. Use a consistent format.